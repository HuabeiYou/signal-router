{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">{{ title }}</h4>
<link rel="stylesheet" href="/static/rule_form.css">
<form method="post" action="{{ form_action }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
  <div class="mb-3">
    <label class="form-label">规则名称</label>
    <input class="form-control" name="name" value="{{ rule.name if rule else '' }}" placeholder="例如：ETF推送到策略群" required>
    <div class="form-text">这是给你自己看的备注名，不会影响匹配和转发结果。</div>
  </div>
  <div class="mb-3">
    <label class="form-label">优先级（越大越先匹配）</label>
    <input class="form-control" type="number" name="priority" value="{{ rule.priority if rule else 0 }}">
  </div>
  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" name="enabled" id="enabled" {% if rule is none or rule.enabled %}checked{% endif %}>
    <label class="form-check-label" for="enabled">启用规则</label>
  </div>
  <div class="mb-3">
    <label class="form-label">匹配方式</label>
    <div class="d-flex flex-column gap-2">
      <label class="form-check match-option">
        <input class="form-check-input" type="radio" name="condition_type" value="always" {% if condition_type == "always" %}checked{% endif %}>
        <span class="form-check-label ms-1">全部消息（无条件命中）</span>
      </label>
      <label class="form-check match-option">
        <input class="form-check-input" type="radio" name="condition_type" value="contains_text" {% if condition_type == "contains_text" %}checked{% endif %}>
        <span class="form-check-label ms-1">消息内容包含关键词</span>
      </label>
      <label class="form-check match-option">
        <input class="form-check-input" type="radio" name="condition_type" value="contains_field" {% if condition_type == "contains_field" %}checked{% endif %}>
        <span class="form-check-label ms-1">消息里包含字段名（如 test）</span>
      </label>
    </div>
  </div>
  <div class="mb-3" id="conditionValueGroup">
    <label class="form-label" id="conditionValueLabel">匹配内容</label>
    <input class="form-control" id="conditionValueInput" name="condition_value" value="{{ condition_value }}" placeholder="根据上面的匹配方式填写">
    <div class="form-text" id="conditionValueHelp"></div>
  </div>
  <div class="mb-3">
    <label class="form-label">要发到哪个群（可填多个）</label>
    <textarea class="form-control" rows="5" name="target_urls" required placeholder="每行一个机器人地址&#10;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=groupA&#10;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=groupB">{{ targets_text }}</textarea>
    <div class="form-text target-box">
      一条规则可以发到多个群：每行填写一个机器人 Webhook 地址。<br>
      去企业微信群添加机器人后复制该地址，形如：<br>
      <code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx</code>
    </div>
  </div>
  <button class="btn btn-primary" type="submit">保存</button>
  <a class="btn btn-outline-secondary" href="/admin/rules">返回</a>
</form>
<script src="/static/rule_form.js"></script>
{% endblock %}
